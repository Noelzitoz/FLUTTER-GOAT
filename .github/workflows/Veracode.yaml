name: Veracode Ultra Workflow (Full Builds + SARIF)

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:

  # -----------------------------
  # ğŸ” Veracode SCA
  # -----------------------------
  sca:
    name: ğŸ” Veracode SCA (SourceClear)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”¬ Run Veracode SCA
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SRCCLR_API_TOKEN }}
        run: |
          echo "ğŸ” Running Veracode SCA..."
          curl -sSL 'https://download.sourceclear.com/ci.sh' | bash -s -- scan

  # -----------------------------
  # ğŸ§© Detect Stack
  # -----------------------------
  detect_stack:
    name: ğŸ§© Detect Project Stack
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - id: detect
        name: ğŸ” Detect Language
        run: |
          echo "Detecting..."
          lang="unsupported"

          if find . -name "pom.xml" | grep -q .; then lang="maven"
          elif find . -name "build.gradle" | grep -q .; then lang="gradle"
          elif find . -name "pubspec.yaml" | grep -q .; then lang="flutter"
          elif find . -name "*.groovy" | grep -q .; then lang="groovy"
          else lang="unknown"; fi

          echo "Detected: $lang"
          echo "language=$lang" >> $GITHUB_OUTPUT

  # -----------------------------
  # âš™ï¸ Build Auto-Packager (Java, Gradle)
  # -----------------------------
  build_auto:
    name: âš™ï¸ Build Auto-Packager
    runs-on: ubuntu-latest
    needs: detect_stack
    if: needs.detect_stack.outputs.language == 'maven' || needs.detect_stack.outputs.language == 'gradle'
    outputs:
      artifact: ${{ steps.find.outputs.artifact }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Run Veracode Auto-Packager
        run: |
          echo "Running Veracode Auto-Packager..."
          curl -sSfL https://tools.veracode.com/veracode-cli/install | sh
          ./veracode package --source . --output veracode-out --trust
          cp veracode-out/*.zip analisysPack.zip

      - id: find
        run: echo "artifact=analisysPack.zip" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: veracode-package
          path: analisysPack.zip

  # -----------------------------
  # ğŸ§ Build Manual Linux (Flutter, Groovy)
  # -----------------------------
  build_manual_linux:
    name: ğŸ§ Build Manual Linux
    runs-on: ubuntu-latest
    needs: detect_stack
    if: |
      needs.detect_stack.outputs.language == 'flutter' ||
      needs.detect_stack.outputs.language == 'groovy'
    outputs:
      artifact: ${{ steps.pack.outputs.artifact }}
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Install Flutter & Dart
        if: needs.detect_stack.outputs.language == 'flutter'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libgl1-mesa-dev

      - name: âš™ï¸ Install Groovy
        if: needs.detect_stack.outputs.language == 'groovy'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y groovy

      - name: âš™ï¸ Setup Flutter
        if: needs.detect_stack.outputs.language == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'

      - name: âš™ï¸ Run Robust Build
        id: pack
        run: |
          mkdir -p output
          lang="${{ needs.detect_stack.outputs.language }}"

          if [ "$lang" = "groovy" ]; then
            echo "ğŸ” Detectado Groovy puro"
            mkdir -p output/groovy
            echo "Compilando *.groovy..."
            groovyc *.groovy -d output/groovy || cp *.groovy output/groovy/
          fi

          if [ "$lang" = "flutter" ]; then
            echo "ğŸ” Procurando TODOS os pubspec.yaml..."
            found_any=0
            mkdir -p output/flutter

            find . -type f -name "pubspec.yaml" | while read pubspec; do
              module_dir=$(dirname "$pubspec")
              echo "ğŸ“Œ MÃ³dulo: $module_dir"
              cd "$module_dir"

              echo "ğŸ“¦ flutter pub get"
              flutter pub get || true

              if grep -q "build_runner" pubspec.yaml; then
                echo "ğŸ”§ build_runner detectado"
                flutter pub run build_runner build --delete-conflicting-outputs || true
              fi

              FLAVOR_ARG=""
              if grep -qi "flavor" pubspec.yaml || ls | grep -q "flavors"; then
                echo "âš™ï¸ PossÃ­vel flavor detectado"
                if grep -qi "prod" pubspec.yaml; then FLAVOR_ARG="--flavor prod"; fi
                if grep -qi "production" pubspec.yaml; then FLAVOR_ARG="--flavor production"; fi
                if grep -qi "stage" pubspec.yaml; then FLAVOR_ARG="--flavor staging"; fi
              fi

              echo "ğŸ—ï¸ flutter build apk $FLAVOR_ARG"
              flutter build apk $FLAVOR_ARG --debug || flutter build apk --debug || true

              echo "ğŸ“‚ Coletando APKs..."
              mkdir -p ../../output/flutter/$module_dir
              cp -r build/app/outputs/flutter-apk/*.apk ../../output/flutter/$module_dir/ || echo "âš ï¸ Nenhum APK encontrado!"

              cd - > /dev/null
            done
          fi

          echo "ğŸ“¦ Compactando final..."
          zip -r analisysPack.zip output
          echo "artifact=analisysPack.zip" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: veracode-package
          path: analisysPack.zip

  # -----------------------------
  # ğŸ” Pipeline Scan + SAST
  # -----------------------------
  pipeline_scan:
    name: ğŸ” Veracode Pipeline Scan
    runs-on: ubuntu-latest
    needs: [build_auto, build_manual_linux]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: veracode-package
          path: ${{ github.workspace }}

      - name: ğŸ§© Run Veracode Pipeline Scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.18
        with:
          vid: ${{ secrets.APIID }}
          vkey: ${{ secrets.APIKEY }}
          file: "analisysPack.zip"
          fail_build: false

  sast:
    name: ğŸ”’ Veracode Upload & SAST
    runs-on: ubuntu-latest
    needs: [build_auto, build_manual_linux]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: veracode-package
          path: ${{ github.workspace }}

      - name: ğŸ”’ Upload & Run Veracode SAST
        uses: veracode/veracode-uploadandscan-action@0.2.8
        with:
          vid: ${{ secrets.APIID }}
          vkey: ${{ secrets.APIKEY }}
          appname: "GitHub - ${{ github.repository }}"
          createprofile: true
          filepath: "analisysPack.zip"
          version: ${{ github.run_id }}
